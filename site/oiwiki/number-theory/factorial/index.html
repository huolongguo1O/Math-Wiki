
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="aofall, c-forrest, CoelacanthusHex, Early0v0, Enter-tainer, Great-designer, iamtwz, Marcythm, Persdre, shuzhouliu, Tiphereth-A, wsyhb, Xeonacid">
      
      
      
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Factorial - Math-wiki</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Math-wiki" class="md-header__button md-logo" aria-label="Math-wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Math-wiki
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Factorial
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  简介

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../ineq/" class="md-tabs__link">
          
  
  
  不等式

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../basic/" class="md-tabs__link">
          
  
  
  数论

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../complex/" class="md-tabs__link">
          
  
  
  杂项

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Math-wiki" class="md-nav__button md-logo" aria-label="Math-wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Math-wiki
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    简介
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    不等式
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    不等式
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ineq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    最最最基本的不等关系
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ineq/am-gm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    均值不等式
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ineq/cauchy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    柯西不等式
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    数论
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    数论
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    基础知识
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mod-arithmetic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    模运算
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prime/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    质数
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gcd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    最大公约数
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bezouts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bezout定理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../inverse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    逆元
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../crt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    中国剩余定理（CRT）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../euler-function.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    欧拉函数
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fermat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    费马小定理与欧拉定理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../primitive-root/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    阶与原根
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../congruence-equation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    同余方程
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linear-congruence-equation.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    线性同余方程
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quadratic-residue.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    二次剩余
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pell-equation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    pell方程
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mobius/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    莫比乌斯反演
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lifting-the-exponent.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LTE引理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quadratic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    二次域
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    杂项
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    杂项
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../complex/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    复数
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        引入
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wilson" class="md-nav__link">
    <span class="md-ellipsis">
      
        Wilson 定理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Wilson 定理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        推广
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        阶乘余数的计算
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="阶乘余数的计算">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        素数模的情形
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        素数幂模的情形
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        幂次的计算
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="幂次的计算">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#legendre" class="md-nav__link">
    <span class="md-ellipsis">
      
        Legendre 公式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kummer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kummer 定理
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        例题
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        参考资料
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Factorial</h1>

<h2 id="_1">引入</h2>
<p>本文讨论了某一模数下阶乘计算的相关结论，并提供一种时间复杂度线性相关于模数大小的计算方法，因而该方法主要适用于模数不太大（<span class="arithmatex">\(\sim 10^6\)</span>）的情形。除了本文介绍的方法外，根据场景不同，还可以应用 <a href="../../poly/shift/#模素数意义下阶乘">多项式技术</a> 进行快速计算。</p>
<p>根据 <a href="../crt/">中国剩余定理</a>，阶乘取模问题可以转化为模数为素数幂 <span class="arithmatex">\(p^\alpha\)</span> 的情形。在处理这类问题时，常常需要对于素数 <span class="arithmatex">\(p\)</span> 和正整数 <span class="arithmatex">\(n\)</span>，将阶乘 <span class="arithmatex">\(n!\)</span> 中的所有因子 <span class="arithmatex">\(p\)</span> 都提取出来，进而得到分解：</p>
<div class="arithmatex">\[
n! = p^{\nu_p(n!)}(n!)_p.
\]</div>
<p>其中，<span class="arithmatex">\(\nu_p(n!)\)</span> 表示阶乘 <span class="arithmatex">\(n!\)</span> 的素因数分解中 <span class="arithmatex">\(p\)</span> 的幂次，<span class="arithmatex">\((n!)_p\)</span> 表示在阶乘 <span class="arithmatex">\(n!\)</span> 的结果中去除所有 <span class="arithmatex">\(p\)</span> 的幂次得到的整数。本文将讨论 <span class="arithmatex">\((n!)_p\)</span> 在素数（幂）模下的余数以及幂次 <span class="arithmatex">\(\nu_p(n!)\)</span> 的具体计算方法。</p>
<p>这种分解在解决阶乘同时出现在所求表达式的分子和分母的问题时尤为有用，比如 <a href="../lucas/">计算某一模数下的二项式系数</a>。对于这类问题，分子和分母中 <span class="arithmatex">\(p\)</span> 的幂次可以直接相减，而与 <span class="arithmatex">\(p\)</span> 互素的部分 <span class="arithmatex">\((n!)_p\)</span> 则可以利用 <a href="../inverse/">乘法逆元</a> 计算。</p>
<p>本文还介绍了与上述问题相关的 Wilson 定理及其推广、Legendre 公式和 Kummer 定理等内容。</p>
<h2 id="wilson">Wilson 定理</h2>
<p>Wilson 定理给出了判断某个自然数是素数的一个充分必要条件。</p>
<p>???+ note "Wilson 定理"
    对于自然数 <span class="arithmatex">\(n&gt;1\)</span>，当且仅当 <span class="arithmatex">\(n\)</span> 是素数时，<span class="arithmatex">\((n-1)!\equiv -1\pmod n\)</span>。</p>
<p>??? note "证明"
    首先，证明对于素数 <span class="arithmatex">\(p\)</span> 有 <span class="arithmatex">\((p-1)!\equiv -1\pmod{p}\)</span>。对于这一点，可以利用 <a href="../congruence-equation/#推论-2">同余方程</a> 或 <a href="../primitive-root/">原根</a> 得到两种简洁的证明，此处略去不表。下面提供前置知识较少的一种证明方法：</p>
<pre><code>当 $p=2$ 时，命题显然成立。下面设 $p\geq 3$，继而要证明 $\mathbf{Z}_p$ 中所有非零元素（即同余类）的积为 $\overline{-1}$。因为 $\mathbf{Z}_p$ 中所有非零元素 $\overline{a}$ 都有逆元 $\overline{a}^{-1}$，于是 $\mathbf{Z}_p$ 中彼此互逆的元素乘积为 $\overline{1}$。但是要注意 $\overline{a}$ 和 $\overline{a}^{-1}$ 可能相等：$\overline{a}=\overline{a}^{-1}$，当且仅当 $a^2\equiv 1\pmod p$，即

$$
0\equiv a^2-1\equiv (a+1)(a-1),\pmod p
$$

从而，$a\equiv 1\pmod p$ 或 $a\equiv -1\pmod p$。这说明 $\mathbf{Z}_p\setminus\{\overline{0},\overline{1},\overline{-1}\}$ 中所有元素的乘积为 $\overline{1}$，进而 $\mathbf{Z}_p$ 中所有非零元素的积为 $\overline{-1}$。

反过来，对于合数 $n$ 的情形，要证明 $(n-1)!\not\equiv-1\pmod{n}$。利用反证法，不妨设 $(n-1)!\equiv -1\pmod{n}$，亦即存在整数 $k$ 使得 $(n-1)!=kn-1$ 成立。因为 $n$ 是合数，必然存在素数 $p&lt;n$ 使得 $n=pm$，所以 $(n-1)!=kpm-1\equiv -1\pmod{p}$。但是，乘积 $(n-1)!$ 中必然已经出现 $p$，故而一定有 $(n-1)!\equiv 0\pmod{p}$。这一矛盾就说明了 $(n-1)!\not\equiv-1\pmod{n}$。
</code></pre>
<p>利用本文的记号，Wilson 定理可以写作 <span class="arithmatex">\((p!)_p\equiv -1\pmod{p}\)</span>。</p>
<h3 id="_2">推广</h3>
<p>Wilson 定理可以推广到一般模数的情形。</p>
<p>???+ note "定理（Gauss）"
    对于自然数 <span class="arithmatex">\(m&gt;1\)</span>，有</p>
<pre><code>$$
\prod_{1\le k&lt;m,\ k\perp m} k \equiv \pm 1 \pmod{m}.
$$

而且，余数中的 $\pm 1$ 取值为 $-1$ 当且仅当模 $m$ 的 [原根存在](./primitive-root.md#原根存在定理)，即 $m=2,4,p^\alpha,2p^\alpha$ 时，其中 $p$ 是奇素数且 $\alpha$ 是正整数。
</code></pre>
<p>??? note "证明"
    这个定理可以通过 <a href="../../algebra/ring-theory/#应用整数同余类的乘法群">模 <span class="arithmatex">\(n\)</span> 整数乘法群</a> 的结构简单地证明。此处给出思路相仿，但是较为初等的证明。</p>
<pre><code>对于 $m=2$ 的情形，有 $1!=1\equiv -1\pmod{2}$。对于其他存在原根的情形，设原根为 $g$，则所有满足小于 $m$ 且与它互素的正整数 $k$ 都可以唯一地表示为 $g^i\bmod m$ 的形式，其中 $0\le i&lt;\varphi(m)$ 且 $\varphi(m)$ 是 [Euler 函数](./euler-totient.md)。直接验证可知，$\varphi(m)$ 一定是偶数。因为 $g^i$ 和 $g^{\varphi(m)-i}$ 互为乘法逆元，所以在乘积中将它们两两配对，就有

$$
\prod_{1\le k&lt;m,\ k\perp m} k \equiv \prod_{i=0}^{\varphi(m)-1}g^i = g^{\varphi(m)/2}\prod_{i=1}^{\varphi(m)/2-1}g^{i}g^{\varphi(m)-i} \equiv g^{\varphi(m)/2} \pmod{m}.
$$

因为 $g^{\varphi(m)/2}\bmod m$ 是唯一的不等于 $1\bmod{m}$ 且乘法逆元就是它自身的元素，所以它就等于 $-1\bmod{m}$。这就说明了此时的余数等于 $-1$。

对于模 $m$ 的原根不存在的情形，要证明余数等于 $1$。为此，可以首先做质因数分解 $m=p_1^{e_1}p_2^{e_2}\cdots p_s^{e_s}$，然后应用 [中国剩余定理](./crt.md) 可知，只需要证明

$$
\prod_{1\le k&lt;m,\ k\perp m} k\equiv 1\pmod{p_j^{e_j}}
$$

对所有因子 $p_j^{e_j}$ 都成立。中国剩余定理说明，每一个可能的余数组合 $(r_1,r_2,\cdots,r_s)$，其中，$1\le r_j&lt;p_j^{e_j}$ 且 $p_j\perp r_j$，都唯一地对应着一个 $1\le k&lt;m$ 且 $k\perp m$ 使得 $k\equiv r_j\pmod{p_j^{e_j}}$ 成立。所以，对于某个余数 $r_j$，都恰好有 ${\varphi(m)}/{\varphi(p_j^{e_j})}$ 个 $k$ 使得 $k\equiv r_j\pmod{p_j^{e_j}}$ 成立。利用这一点，可以对乘积进行分组，就有

$$
\prod_{1\le k&lt;m,\ k\perp m} k\equiv\left(\prod_{1\le r_j&lt;p_j^{e_j},\ r_j\perp p_j} r_j\right)^{{\varphi(m)}/{\varphi(p_j^{e_j})}}\pmod{p_j^{e_j}}.
$$

此处的指数 ${\varphi(m)}/{\varphi(p_j^{e_j})}=\varphi(m/p_j^{e_j})$ 要成为奇数，必然要求 $m/p_j^{e_j}=1,2$，因为欧拉函数 $\varphi(n)$ 对于 $n\ge 3$ 都是偶数。如果 $p_j$ 是奇素数，因为模 $m$ 的原根不存在，必然有 $m/p_j^{e_j}\neq 1,2$；如果 $p_j^{e_j}=2,4$，因为模 $m$ 的原根不存在，必然有 $m/p_j^{e_j}$ 含有某个奇素因子，故而大于 $2$：这两种情形指数 ${\varphi(m)}/{\varphi(p_j^{e_j})}$ 都是偶数。而上式中括号里的项已经证明是模 $p_j^{e_j}$ 余 $-1$ 的，所以这个幂模 $p_j^{e_j}$ 的余数一定是 $1$。剩余的情形只有 $p_j=2$ 且 $e_j&gt;2$ 时，对于这个情形，可以直接证明 \`

$$
\prod_{1\le r_j&lt;2^{e_j},\ r_j\perp 2}r_j \equiv 1\pmod{2^{e_j}}.
$$

仿照前文的证明思路，可以将所有 $1\le r_j&lt;2^{e_j}$ 的奇数 $r_j$ 两两配对而消去，那些无法配对的必然是方程 $x^2\equiv 1\pmod{2^{e_j}}$ 的解。该方程意味着 $2^{e_j}\mid (x-1)(x+1)$。令 $x=2y+1$，就必然有 $2^{e_j-2}\mid y(y+1)$，而 $y$ 和 $y+1$ 必然一奇一偶，所以 $y=t2^{e_j-2}$ 或 $y=t2^{e_j-2}-1$。故而，有 $x=t2^{e_j-1}\pm 1$ 且 $t$ 是整数。模 $2^{e_j}$ 的余数中，只有 $\pm 1$ 和 $2^{e_j-1}\pm 1$ 四个。因此，有

$$
\prod_{1\le r_j&lt;2^{e_j},\ r_j\perp 2}r_j \equiv (-1)(2^{e_j-1}-1)(2^{e_j-1}+1) \equiv 1\pmod{2^{e_j}}.
$$

这就完成了所有情形的证明。
</code></pre>
<p>在计算中，尤为重要的是模数为素数幂的情形：</p>
<p>???+ note "推论"
    对于素数 <span class="arithmatex">\(p\)</span> 和正整数 <span class="arithmatex">\(\alpha\)</span>，有</p>
<pre><code>$$
\prod_{1\le k&lt;p^\alpha,\ k\perp p}k \equiv 
\begin{cases}
1, &amp; p=2\text{ and }\alpha\ge3,\\
-1, &amp;\text{otherwise}
\end{cases}
\pmod{p^\alpha}.
$$
</code></pre>
<p>注意，左侧并非 <span class="arithmatex">\((p^\alpha!)_p\)</span>，因为后者还需要统计 <span class="arithmatex">\(p\)</span> 的倍数的贡献。</p>
<h2 id="_3">阶乘余数的计算</h2>
<p>本节讨论余数 <span class="arithmatex">\((n!)_p\bmod p^{\alpha}\)</span> 的计算。</p>
<h3 id="_4">素数模的情形</h3>
<p>算式 <span class="arithmatex">\((n!)_p\)</span> 有明显的递归结构。为注意到这一点，首先考察一个具体的例子：</p>
<p>???+ example "例子"
    要计算 <span class="arithmatex">\((32!)_5 \bmod{5}\)</span>，可以做如下递归计算：</p>
<pre><code>$$
\begin{aligned}
(32!)_5 &amp;= 1\times 2\times 3 \times 4\times \underbrace{1}_{5}\times 6 \times 7 \times 8\times 9 \times \underbrace{2}_{10} \\
&amp;\quad\times 11 \times 12 \times 13 \times 14\times \underbrace{3}_{15}\times 16 \times 17\times 18\times 19\times \underbrace{4}_{20} \\
&amp;\quad\times 21 \times 22 \times 23 \times 24\times \underbrace{1}_{25}\times 26 \times 27\times 28\times 29\times \underbrace{6}_{30} \times 31 \times 32 \\
&amp;\equiv 1\times 2\times 3 \times 4\times \underbrace{1}_{5}\times 1 \times 2 \times 3\times 4 \times \underbrace{2}_{10} \\
&amp;\quad\times 1 \times 2 \times 3 \times 4\times \underbrace{3}_{15}\times 1 \times 2\times 3\times 4\times \underbrace{4}_{20} \\
&amp;\quad\times 1 \times 2 \times 3 \times 4\times \underbrace{1}_{25}\times 1 \times 2\times 3\times 4\times \underbrace{1}_{30}\times 1\times 2\\
&amp;= (1\times 2\times 3\times 4)^{6}\times(1\times 2)\times(\underbrace{1}_{5}\times \underbrace{2}_{10}\times \underbrace{3}_{15} \times \underbrace{4}_{20}\times \underbrace{1}_{25}\times \underbrace{1}_{30}) \pmod{5}
\end{aligned}
$$

可以看出，利用模 $5$ 余数的周期性，可以将这一乘积划分为若干个长度为 $5$ 的块，每一块的唯一差异就是最后一个元素的余数。因为 $32$ 除以 $5$ 得到的商是 $6$ 且余数是 $2$，所以，该乘积可以划分为 $6$ 个完整的块和最后一段长度为 $2$ 的不完整的块。因此，可以将前 $6$ 个块除了最后一个元素之外的部分提取出来（这一部分恰好是 Wilson 定理能够解决的），再乘上最后一个不完整的块的乘积，最后乘上前 $6$ 个块的最后一个元素的连乘积。每个块的最后一个元素都是 $5$ 的倍数，去掉 $5$ 的幂次后，它们的连乘积恰好是 $(6!)_{5}\pmod{5}$。这就将原来的问题转化为了规模更小的问题。
</code></pre>
<p>将该例子中的递归的结构一般化，就得到如下递推公式：</p>
<p>???+ note "递推公式"
    对于素数 <span class="arithmatex">\(p\)</span> 和正整数 <span class="arithmatex">\(n\)</span>，有</p>
<pre><code>$$
(n!)_p \equiv (-1)^{\left\lfloor n/p\right\rfloor}\cdot (n\bmod p)!\cdot\left(\left\lfloor n/p\right\rfloor!\right)_p\pmod{p}.
$$
</code></pre>
<p>??? note "证明"
    记 <span class="arithmatex">\((n)_p\)</span> 为 <span class="arithmatex">\(n\)</span> 的素因数分解中去除所有 <span class="arithmatex">\(p\)</span> 的幂次的结果。于是，有</p>
<pre><code>$$
\begin{aligned}
(n!)_p &amp;= \prod_{k=1}^n(k)_p = \left(\prod_{1\le k\le n,\ k\perp p}(k)_p\right)\left(\prod_{1\le k\le\lfloor n/p\rfloor}(pk)_p\right) \\
&amp;= \left(\prod_{i=0}^{\lfloor n/p\rfloor-1}\prod_{j=1}^{p-1}(ip+j)\right)\left(\prod_{j=1}^{n\bmod p}(\lfloor n/k\rfloor k+j)\right)\left(\prod_{1\le k\le\lfloor n/p\rfloor}(k)_p\right) \\
&amp;\equiv\left(\prod_{j=1}^{p-1}j\right)^{\lfloor n/p\rfloor}\left(\prod_{j=1}^{n\bmod p}j\right)(\lfloor n/p\rfloor!)_p \\
&amp;\equiv (-1)^{\lfloor n/p\rfloor}\cdot(n\bmod p)!\cdot(\lfloor n/p\rfloor!)_p \pmod p.
\end{aligned}
$$

这就完成了证明。下面对于该形式证明提供具体的解释。

要计算 $(n!)_p\bmod p$ 的值。仿照上面的例子，有

$$
\begin{aligned}
(n!)_p &amp;= 1 \cdot 2 \cdot 3 \cdot \ldots \cdot (p-2) \cdot (p-1) \cdot \underbrace{1}_{p} \cdot (p+1) \cdot (p+2) \cdot \ldots \cdot (2p-1) \cdot \underbrace{2}_{2p} \\
&amp;\quad \cdot (2p+1) \cdot \ldots \cdot (p^2-1) \cdot \underbrace{1}_{p^2} \cdot (p^2 +1) \cdot \ldots \cdot n \pmod{p} \\
&amp;= 1 \cdot 2 \cdot 3 \cdot \ldots \cdot (p-2) \cdot (p-1) \cdot \underbrace{1}_{p} \cdot 1 \cdot 2 \cdot \ldots \cdot (p-1) \cdot \underbrace{2}_{2p} \cdot 1 \cdot 2 \\
&amp;\quad \cdot \ldots \cdot (p-1) \cdot \underbrace{1}_{p^2} \cdot 1 \cdot 2 \cdot \ldots \cdot (n \bmod p) \pmod{p}.
\end{aligned}
$$

可以清楚地看到，除了最后一个块外，阶乘被划分为几个长度相同的完整的块。

$$
\begin{aligned}
(n!)_p&amp;= \underbrace{1 \cdot 2 \cdot 3 \cdot \ldots \cdot (p-2) \cdot (p-1) \cdot 1}_{1\text{st}} \cdot \underbrace{1 \cdot 2 \cdot 3 \cdot \ldots \cdot (p-2) \cdot (p-1) \cdot 2}_{2\text{nd}} \cdot \ldots \\
&amp;\quad \cdot \underbrace{1 \cdot 2 \cdot 3 \cdot \ldots \cdot (p-2) \cdot (p-1) \cdot 1}_{p\text{th}} \cdot \ldots \cdot \quad \underbrace{1 \cdot 2 \cdot \cdot \ldots \cdot (n \bmod p)}_{\text{tail}} \pmod{p}.
\end{aligned}
$$

除了块的最后一个元素外，完整的块的主要部分 $(p-1)!\ \mathrm{mod}\ p$ 很容易计算，可以应用 Wilson 定理：

$$
(p-1)!\equiv -1\pmod p.
$$

总共有 $\left\lfloor \dfrac{n}{p} \right\rfloor$ 个完整的块，因此需要将 $\left\lfloor \dfrac{n}{p} \right\rfloor$ 写到 $-1$ 的指数上。

最后一个部分块的值就是 $(n\bmod p)!\bmod p$，可以单独计算。

剩下的就是每个块的最后一个元素。如果隐藏已处理的元素，可以看到以下模式：

$$
(n!)_p = \underbrace{ \ldots \cdot 1 } \cdot \underbrace{ \ldots \cdot 2} \cdot \ldots \cdot \underbrace{ \ldots \cdot (p-1)} \cdot \underbrace{ \ldots \cdot 1 } \cdot \underbrace{ \ldots \cdot 1} \cdot \underbrace{ \ldots \cdot 2} \cdots
$$

这也是一个修正的阶乘，只是长度短得多。它是：

$$
\left(\left\lfloor \frac{n}{p} \right\rfloor !\right)_p.
$$

将各部分乘起来，就得到上面的递推公式。
</code></pre>
<p>利用该递推式做计算，递归深度为 <span class="arithmatex">\(O(\log_p n)\)</span>。如果每次都重新计算中间那一项，那么每层计算的复杂度都是 <span class="arithmatex">\(O(p)\)</span> 的，总的时间复杂度是 <span class="arithmatex">\(O(p\log_p n)\)</span>；如果对所有 <span class="arithmatex">\(n=1,2,\cdots,p-1\)</span> 都预先处理了 <span class="arithmatex">\(n!\bmod p\)</span>，那么预处理的复杂度是 <span class="arithmatex">\(O(p)\)</span> 的，每层计算的复杂度都是 <span class="arithmatex">\(O(1)\)</span> 的，总的时间复杂度是 <span class="arithmatex">\(O(p+\log_p n)\)</span> 的。</p>
<p>在实现时，因为是尾递归，可以用迭代实现。下面的实现对前 <span class="arithmatex">\(p-1\)</span> 个阶乘做了预计算，如果需要多次调用，可以将预计算放到函数外进行。</p>
<p>??? example "参考实现"
    <code>cpp
    --8&lt;-- "docs/math/code/factorial/fact-mod-p.cpp:core"</code></p>
<p>如果空间有限，无法存储所有阶乘，也可以将函数调用中实际用到的阶乘 <span class="arithmatex">\(n!\bmod p\)</span> 中的 <span class="arithmatex">\(n\)</span> 都计算出来，然后对它们进行排序，从而可以在最后一次性计算出来这些阶乘的值，汇总到最终结果中，而避免存储所有阶乘的值。</p>
<h3 id="_5">素数幂模的情形</h3>
<p>对于素数幂模的情形，可以仿照素数模的情形解决，只需要将 Wilson 定理替换成它的推广形式。本节两个结论中的 <span class="arithmatex">\(\pm 1\)</span>，均特指这样的定义：当模数 <span class="arithmatex">\(p=2\)</span> 且 <span class="arithmatex">\(\alpha\ge 3\)</span> 时取 <span class="arithmatex">\(1\)</span>，其余情形取 <span class="arithmatex">\(-1\)</span>。</p>
<p>???+ note "递推公式"
    对于素数 <span class="arithmatex">\(p\)</span> 和正整数 <span class="arithmatex">\(\alpha,n\)</span>，有</p>
<pre><code>$$
(n!)_{p} \equiv (\pm 1)^{\lfloor n/p^\alpha\rfloor}\cdot\left(\prod_{1\le j\le (n\bmod p^\alpha),\ j\perp p}j\right)\cdot(\lfloor n/p\rfloor!)_p\pmod{p^\alpha}.
$$

其中，$\pm 1$ 的取值如同 [Wilson 定理的推广](#推广) 中规定的那样。
</code></pre>
<p>??? note "证明"
    证明思路和素数模的情形完全一致。记 <span class="arithmatex">\((k)_p\)</span> 为去除 <span class="arithmatex">\(k\)</span> 的素因数分解中 <span class="arithmatex">\(p\)</span> 的全部幂次的结果，则</p>
<pre><code>$$
\begin{aligned}
(n!)_p
&amp;= \prod_{1\le k\le n}(k)_p = \left(\prod_{1\le k\le n,\ k\perp p}(k)_p\right)\left(\prod_{1\le k\le\lfloor n/p\rfloor}(pk)_p\right) \\
&amp;= \left(\prod_{i=0}^{\lfloor n/p^\alpha\rfloor-1}\prod_{1\le j\le p^\alpha,\ j\perp p}(ip^\alpha+j)_p\right)\left(\prod_{1\le j\le (n\bmod p^\alpha),\ j\perp p}(\lfloor n/p^\alpha\rfloor p^\alpha+j)_p\right)\left(\prod_{1\le k\le\lfloor n/p\rfloor}(k)_p\right)\\
&amp;\equiv \left(\prod_{1\le j\le p^\alpha,\ j\perp p}j\right)^{\lfloor n/p^\alpha\rfloor}\cdot\left(\prod_{1\le j\le (n\bmod p^\alpha),\ j\perp p}j\right)\cdot(\lfloor n/p\rfloor!)_p\\
&amp;\equiv (\pm 1)^{\lfloor n/p^\alpha\rfloor}\cdot\left(\prod_{1\le j\le (n\bmod p^\alpha),\ j\perp p}j\right)\cdot(\lfloor n/p\rfloor!)_p \pmod{p^\alpha}.
\end{aligned}
$$
</code></pre>
<p>与素数模的情形不同之处，除了 <span class="arithmatex">\(-1\)</span> 可能需要替换为 <span class="arithmatex">\(\pm 1\)</span> 之外，还需要注意预处理的数据的不同。对于素数幂模的情形，需要对所有不超过 <span class="arithmatex">\(p^\alpha\)</span> 的正整数 <span class="arithmatex">\(n\)</span> 预处理自 <span class="arithmatex">\(1\)</span> 至 <span class="arithmatex">\(n\)</span> 但并非 <span class="arithmatex">\(p\)</span> 的倍数的所有整数的乘积，即</p>
<div class="arithmatex">\[
\prod_{1\le k\le n,\ k\perp p} k\bmod{p^\alpha}.
\]</div>
<p>在素数模的情形，它退化为 <span class="arithmatex">\(n!\bmod p\)</span>，但是该表达式在一般的素数幂的情形不再适用。</p>
<p>下面提供了在素数幂模的情形下计算阶乘余数的例子，以便理解上述方法：</p>
<p>???+ example "例子"
    要计算 <span class="arithmatex">\((32!)_3\bmod 9\)</span>，可以做如下递归计算：</p>
<pre><code>$$
\begin{aligned}
(32!)_3 
&amp;= 1\times 2\times \underbrace{1}_{3} \times 4\times 5\times \underbrace{2}_{6}\times 7\times 8\times\underbrace{1}_{9}\\
&amp;\quad\times 10\times 11\times\underbrace{4}_{12}\times 13\times 14\times\underbrace{5}_{15}\times 16\times 17\times\underbrace{2}_{18}\\
&amp;\quad\times 19\times 20\times\underbrace{7}_{21}\times 22\times 23\times\underbrace{8}_{24}\times 25\times 26\times\underbrace{1}_{27}\\
&amp;\quad\times 28\times 29\times\underbrace{10}_{30}\times 31\times 32\\
&amp;\equiv 1\times 2\times \underbrace{1}_{3} \times 4\times 5\times \underbrace{2}_{6}\times 7\times 8\times\underbrace{1}_{9}\\
&amp;\quad\times 1\times 2\times\underbrace{4}_{12}\times 4\times 5\times\underbrace{5}_{15}\times 7\times 8\times\underbrace{2}_{18}\\
&amp;\quad\times 1\times 2\times\underbrace{7}_{21}\times 4\times 5\times\underbrace{8}_{24}\times 7\times 8\times\underbrace{1}_{27}\\
&amp;\quad\times 1\times 2\times\underbrace{1}_{30}\times 4\times 5\\
&amp;=(1\times 2\times 4\times 5\times 7\times 8)^{3}\times (1\times 2\times 4\times 5)\\
&amp;\quad\times\begin{pmatrix}\underbrace{1}_{3}\times\underbrace{2}_{6}\times\underbrace{1}_{9}\times\underbrace{4}_{12}\times\underbrace{5}_{15}\times\underbrace{2}_{18}\\\times\underbrace{7}_{21}\times\underbrace{8}_{24}\times\underbrace{1}_{27}\times\underbrace{1}_{30}\end{pmatrix}\pmod{9}.
\end{aligned}
$$

将 $(32!)_3\bmod 9$ 的算式分解的结果同样可以分为三部分：

-   完整的块：由 $1\sim 9$ 之间所有不被 $3$ 整除的整数的乘积，共 $\lfloor 32/9\rfloor=3$ 块；
-   尾部不完整的块：所有不被 $3$ 整除的整数从 $1$ 一直乘到 $32\bmod 9$；
-   所有被 $3$ 整除的整数的乘积，对比倒数第二个等号的结果可知，这就是它的前 $\lfloor 32/3\rfloor=10$ 项，亦即 $(\lfloor 32/3\rfloor!)_3\bmod 9$。

最后一个括号里的递归求解即可，这样就将原问题转化为了更小的问题。
</code></pre>
<p>由此，就可以得到如下递推结果：</p>
<p>???+ note "递推结果"
    对于素数 <span class="arithmatex">\(p\)</span> 和正整数 <span class="arithmatex">\(\alpha,n\)</span>，有</p>
<pre><code>$$
(n!)_p \equiv (\pm 1)^{\sum_{j\ge\alpha}\lfloor{n}/{p^j}\rfloor}\prod_{j\ge 0}F(\lfloor n/p^j\rfloor\bmod p^\alpha),
$$

其中，$F(m) = \prod_{1\le k\le m,\ k\perp p} k\bmod{p^\alpha}$ 且 $\pm 1$ 的取值与上文所述相同。
</code></pre>
<p>素数幂模的情形的实现和素数模的情形类似，只有一些细节上的区别。与上文类似，同样可以将预处理放到函数外进行。</p>
<p>??? example "参考实现"
    <code>cpp
    --8&lt;-- "docs/math/code/factorial/fact-mod-pa.cpp:core"</code></p>
<p>预处理的时间复杂度为 <span class="arithmatex">\(O(p^\alpha)\)</span>，单次询问的时间复杂度为 <span class="arithmatex">\(O(\log_p n)\)</span>。</p>
<h2 id="_6">幂次的计算</h2>
<p>本节讨论阶乘 <span class="arithmatex">\(n!\)</span> 中 <span class="arithmatex">\(p\)</span> 的幂次 <span class="arithmatex">\(\nu_p(n!)\)</span> 的计算，它可以用于计算二项式系数的余数。因为二项式系数中，分子和分母都会出现阶乘，而分子和分母中素数 <span class="arithmatex">\(p\)</span> 能否互相抵消，就成为了决定最后的余数的重要因素。</p>
<h3 id="legendre">Legendre 公式</h3>
<p>阶乘 <span class="arithmatex">\(n!\)</span> 中素数 <span class="arithmatex">\(p\)</span> 的幂次可以通过 Legendre 公式计算，而且与 <span class="arithmatex">\(n\)</span> 在 <span class="arithmatex">\(p\)</span> 进制下的表示有关。</p>
<p>???+ note "Legendre 公式"
    对于正整数 <span class="arithmatex">\(n\)</span>，阶乘 <span class="arithmatex">\(n!\)</span> 中含有的素数 <span class="arithmatex">\(p\)</span> 的幂次 <span class="arithmatex">\(\nu_p(n!)\)</span> 为</p>
<pre><code>$$
\nu_p(n!) = \sum_{i=1}^{\infty} \left\lfloor \dfrac{n}{p^i} \right\rfloor = \dfrac{n-S_p(n)}{p-1},
$$

其中，$S_p(n)$ 为 $p$ 进制下 $n$ 的各个数位的和。特别地，阶乘中 $2$ 的幂次是 $\nu_2(n!)=n-S_2(n)$。
</code></pre>
<p>??? note "证明"
    因为</p>
<pre><code>$$
n! = 1\times 2\times \cdots \times p\times \cdots \times 2p\times \cdots \times \lfloor n/p\rfloor p\times \cdots \times n.
$$

其中，$p$ 的倍数的乘积为 $p\times 2p\times \cdots \times \lfloor n/p\rfloor p=p^{\lfloor n/p\rfloor }\lfloor n/p\rfloor !$，而 $\lfloor n/p\rfloor !$ 可能继续出现 $p$ 的倍数。所以，对于幂次，有递推关系：

$$
\nu_p(n!) = \lfloor n/p\rfloor + \nu_p(\lfloor n/p\rfloor!).
$$

将它展开就得到 Legendre 公式。

要证明第二个等号，首先将 $n$ 展开为 $p$ 进制，这相当于将它写作如下和式：

$$
n = n_\ell p^{\ell} + \cdots + n_1 p + n_0 = \sum_{k=0}^\ell n_kp^k.
$$

因此，有

$$
\begin{aligned}
\nu_p(n!)
&amp;= \sum_{i=1}^{\ell}\left\lfloor\dfrac{n}{p^i}\right\rfloor 
= \sum_{i=1}^\ell\sum_{k=i}^{\ell}n_kp^{k-i}
= \sum_{k=1}^\ell n_k\sum_{i=1}^kp^{k-i} \\
&amp;= \sum_{k=1}^\ell n_k\dfrac{p^k-1}{p-1} 
= \dfrac{\sum_{k=0}^\ell n_kp^k - \sum_{k=0}^\ell n_k}{p-1} 
= \dfrac{n - S_p(n)}{p-1}.
\end{aligned}
$$
</code></pre>
<p>求阶乘中素数幂次的参考实现如下：</p>
<p>??? example "参考实现"
    <code>cpp
    --8&lt;-- "docs/math/code/factorial/multiplicity.cpp:core"</code></p>
<p>它的时间复杂度为 <span class="arithmatex">\(O(\log n)\)</span>。</p>
<h3 id="kummer">Kummer 定理</h3>
<p>组合数对一个数取模的结果，往往构成分形结构，例如谢尔宾斯基三角形就可以通过组合数模 <span class="arithmatex">\(2\)</span> 得到。</p>
<p>如果仔细分析，<span class="arithmatex">\(p\)</span> 是否整除组合数其实和上下标在 <span class="arithmatex">\(p\)</span> 进制下减法是否需要借位有关。这就有了 <strong>Kummer 定理</strong>。</p>
<p>???+ note "Kummer 定理"
    素数 <span class="arithmatex">\(p\)</span> 在组合数 <span class="arithmatex">\(\dbinom{m}{n}\)</span> 中的幂次，恰好是 <span class="arithmatex">\(p\)</span> 进制下 <span class="arithmatex">\(m\)</span> 减掉 <span class="arithmatex">\(n\)</span> 需要借位的次数，亦即</p>
<pre><code>$$
\nu_p\left(\dbinom{m}{n}\right)=\frac{S_p(n)+S_p(m-n)-S_p(m)}{p-1}.
$$

特别地，组合数中 $2$ 的幂次是 $\nu_2\left(\dbinom{m}{n}\right)=S_2(n)+S_2(m-n)-S_2(m)$.
</code></pre>
<p>??? note "证明"
    首先证明下面的表达式。为此，利用 Legendre 公式，有</p>
<pre><code>$$
\begin{aligned}
\nu_p\left(\dbinom{m}{n}\right)
&amp;=\nu_p(m!)-\nu_p(n!)-\nu_p((m-n)!)\\
&amp;=\sum_{i=1}^\infty\left(\left\lfloor\dfrac{m}{p^i}\right\rfloor-\left\lfloor\dfrac{n}{p^i}\right\rfloor-\left\lfloor\dfrac{m-n}{p^i}\right\rfloor\right)\\
&amp;=\frac{S_p(n)+S_p(m-n)-S_p(m)}{p-1}.
\end{aligned}
$$

该表达式可以理解为 $p$ 进制下 $m$ 减掉 $n$ 需要借位的次数。因为如果在计算第 $i$ 位（最低位下标是 $1$）时存在不够减需要借位的情况，那么相减的结果中第 $i$ 位之前的数字 $\left\lfloor\dfrac{m-n}{p^i}\right\rfloor$，其实是 $m$ 中第 $i$ 位之前的数字 $\left\lfloor\dfrac{m}{p^i}\right\rfloor$，减去一（即借掉的一），再减去 $n$ 中第 $i$ 位之前的数字得到的差值 $\left\lfloor\dfrac{n}{p^i}\right\rfloor$，所以，差值

$$
\left\lfloor\dfrac{m}{p^i}\right\rfloor-\left\lfloor\dfrac{n}{p^i}\right\rfloor-\left\lfloor\dfrac{m-n}{p^i}\right\rfloor = 1
$$

当且仅当发生了一次借位；否则，该差值为 $0$。因此，上述表达式中的求和式就可以理解为借位发生的次数。这就得到了 Kummer 定理的文字表述。
</code></pre>
<h2 id="_7">例题</h2>
<p>???+ example "例题 <a href="https://acm.hdu.edu.cn/showproblem.php?pid=2973">HDU 2973 - YAPTCHA</a>"
    给定 <span class="arithmatex">\(n\)</span>, 计算</p>
<pre><code>$$
\sum_{k=1}^n\left\lfloor\frac{(3k+6)!+1}{3k+7}-\left\lfloor\frac{(3k+6)!}{3k+7}\right\rfloor\right\rfloor
$$
</code></pre>
<p>??? note "解题思路"
    若 <span class="arithmatex">\(3k+7\)</span> 是质数，则</p>
<pre><code>$$
(3k+6)!\equiv-1\pmod{3k+7}
$$

设 $(3k+6)!+1=k(3k+7)$

则

$$
\left\lfloor\frac{(3k+6)!+1}{3k+7}-\left\lfloor\frac{(3k+6)!}{3k+7}\right\rfloor\right\rfloor=\left\lfloor k-\left\lfloor k-\frac{1}{3k+7}\right\rfloor\right\rfloor=1
$$

若 $3k+7$ 不是质数，则有 $(3k+7)\mid(3k+6)!$，即

$$
(3k+6)!\equiv 0\pmod{3k+7}
$$

设 $(3k+6)!=k(3k+7)$，则

$$
\left\lfloor\frac{(3k+6)!+1}{3k+7}-\left\lfloor\frac{(3k+6)!}{3k+7}\right\rfloor\right\rfloor=\left\lfloor k+\frac{1}{3k+7}-k\right\rfloor=0
$$

因此

$$
\sum_{k=1}^n\left\lfloor\frac{(3k+6)!+1}{3k+7}-\left\lfloor\frac{(3k+6)!}{3k+7}\right\rfloor\right\rfloor=\sum_{k=1}^n[3k+7\text{ is prime}]
$$
</code></pre>
<p>??? example "参考代码"
    <code>cpp
    --8&lt;-- "docs/math/code/factorial/wilson_1.cpp"</code></p>
<h2 id="_8">参考资料</h2>
<ul>
<li>冯克勤。《初等数论及其应用》。</li>
<li><a href="https://en.wikipedia.org/wiki/Wilson%27s_theorem">Wilson's theorem - Wikipedia</a></li>
<li><a href="https://en.wikipedia.org/wiki/Legendre%27s_formula">Legendre's formula - Wikipedia</a></li>
</ul>
<p><strong>本页面主要译自博文 <a href="http://e-maxx.ru/algo/modular_factorial">Вычисление факториала по модулю</a> 与其英文翻译版 <a href="https://cp-algorithms.com/algebra/factorial-modulo.html">Factorial modulo p</a>。其中俄文版版权协议为 Public Domain + Leave a Link；英文版版权协议为 CC-BY-SA 4.0。内容有改动。</strong></p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.expand", "navigation.tabs"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>