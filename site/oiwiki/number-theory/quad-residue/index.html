
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="hly1204, ShaoChenHeng, Chrogeek, Enter-tainer, Great-designer, iamtwz, monkeysui, nanmenyangde, rgw2010, sshwy, StudyingFather, TachikakaMin, Tiphereth-A, Xeonacid, xyf007, marscheng1">
      
      
      
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Quad residue - Math-wiki</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Math-wiki" class="md-header__button md-logo" aria-label="Math-wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Math-wiki
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Quad residue
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  简介

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../ineq/" class="md-tabs__link">
          
  
  
  不等式

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../basic/" class="md-tabs__link">
          
  
  
  数论

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../complex/" class="md-tabs__link">
          
  
  
  杂项

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Math-wiki" class="md-nav__button md-logo" aria-label="Math-wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Math-wiki
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    简介
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    不等式
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    不等式
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ineq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    最最最基本的不等关系
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ineq/am-gm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    均值不等式
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ineq/cauchy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    柯西不等式
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    数论
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    数论
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    基础知识
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mod-arithmetic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    模运算
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prime/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    质数
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gcd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    最大公约数
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bezouts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bezout定理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../inverse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    逆元
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../crt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    中国剩余定理（CRT）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../euler-function.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    欧拉函数
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fermat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    费马小定理与欧拉定理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../primitive-root/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    阶与原根
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../congruence-equation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    同余方程
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linear-congruence-equation.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    线性同余方程
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quadratic-residue.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    二次剩余
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pell-equation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    pell方程
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mobius/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    莫比乌斯反演
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lifting-the-exponent.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LTE引理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quadratic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    二次域
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    杂项
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    杂项
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../complex/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    复数
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        引入
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        定义
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#euler" class="md-nav__link">
    <span class="md-ellipsis">
      
        Euler 判别法
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#legendre" class="md-nav__link">
    <span class="md-ellipsis">
      
        Legendre 符号
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Legendre 符号">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        性质
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        二次互反律
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jacobi" class="md-nav__link">
    <span class="md-ellipsis">
      
        Jacobi 符号
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        模意义下开平方
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="模意义下开平方">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        特殊情况时的算法
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="特殊情况时的算法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#atkin" class="md-nav__link">
    <span class="md-ellipsis">
      
        Atkin 算法
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cipolla" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cipolla 算法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bostanmori" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bostan–Mori 算法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#legendre_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Legendre 算法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tonellishanks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tonelli–Shanks 算法
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        习题
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        参考资料与注释
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Quad residue</h1>

<h2 id="_1">引入</h2>
<p>二次剩余可以认为是在讨论求模意义下 <strong>开平方</strong> 运算的可行性。对于更高次方的开方可参见 <a href="../residue/">k 次剩余</a>。</p>
<h2 id="_2">定义</h2>
<p>???+ abstract "二次剩余"
    令整数 <span class="arithmatex">\(a\)</span>，<span class="arithmatex">\(p\)</span> 满足 <span class="arithmatex">\((a,p)=1\)</span>，若存在整数 <span class="arithmatex">\(x\)</span> 使得</p>
<pre><code>$$
x^2\equiv a\pmod p,
$$

则称 $a$ 为模 $p$ 的二次剩余，否则称 $a$ 为模 $p$ 的二次非剩余。后文可能在模 $p$ 显然的情况下简写成二次（非）剩余。
</code></pre>
<h2 id="euler">Euler 判别法</h2>
<p>当模数为奇素数时，我们有如下定理：</p>
<p>???+ abstract "Euler 判别法"
    对奇素数 <span class="arithmatex">\(p\)</span> 和满足 <span class="arithmatex">\((a,p)=1\)</span> 的整数 <span class="arithmatex">\(a\)</span>，有</p>
<pre><code>$$
a^{\frac{p-1}{2}}\equiv\begin{cases}
    1 \pmod p,  &amp; (\exists x\in\mathbf{Z}),~~a\equiv x^2\pmod p,\\
    -1 \pmod p, &amp; \text{otherwise}.\\
\end{cases}
$$

即对上述的 $p$ 和 $a$，

1.  $a$ 是 $p$ 的二次剩余当且仅当 $a^{\frac{p-1}{2}}\equiv 1 \pmod p$.
2.  $a$ 是 $p$ 的二次非剩余当且仅当 $a^{\frac{p-1}{2}}\equiv -1 \pmod p$.
</code></pre>
<p>??? note "证明"
    首先由 <a href="../fermat/#费马小定理">Fermat 小定理</a> 有 <span class="arithmatex">\(a^{p-1}\equiv 1\pmod p\)</span>，故</p>
<pre><code>$$
\left(a^{\frac{p-1}{2}}+1\right)\left(a^{\frac{p-1}{2}}-1\right)\equiv 0\pmod p,
$$

从而对任意满足 $(a,p)=1$ 的 $a$ 均有 $a^{(p-1)/2}\equiv \pm 1\pmod p.$

另外由 $p$ 是奇素数，我们有：

$$
x^{p-1}-a^{\frac{p-1}{2}}={\left(x^2\right)}^{\frac{p-1}{2}}-a^{\frac{p-1}{2}}=(x^2-a)P(x),
$$

其中 $P(x)$ 是某个整系数多项式，进而：

$$
\begin{aligned}
    x^p-x&amp;=x\left(x^{p-1}-a^{\frac{p-1}{2}}\right)+x\left(a^{\frac{p-1}{2}}-1\right)\\
    &amp;=(x^2-a)xP(x)+\left(a^{\frac{p-1}{2}}-1\right)x.\\
\end{aligned}
$$

由 [同余方程的定理 5](./congruence-equation.md#定理-5) 可知，$a$ 是模 $p$ 的二次剩余当且仅当 $a^{(p-1)/2}\equiv 1\pmod p$. 进而 $a$ 是模 $p$ 的非二次剩余当且仅当 $a^{(p-1)/2}\equiv -1\pmod p$.
</code></pre>
<p>基于 Euler 判别法，我们可以得到如下推论：</p>
<p>???+ note "二次剩余的数量"
    对于奇素数 <span class="arithmatex">\(p\)</span>，模 <span class="arithmatex">\(p\)</span> 意义下二次剩余和二次非剩余均有 <span class="arithmatex">\(\dfrac{p-1}{2}\)</span> 个。</p>
<p>??? note "证明"
    根据 Euler 判别法，考虑 <span class="arithmatex">\(a^{\frac{p-1}{2}}\equiv 1\pmod p.\)</span></p>
<pre><code>注意到 $\dfrac{p-1}{2}\mid (p-1)$，由 [同余方程的定理 6](./congruence-equation.md#定理-6) 可知 $a^{\frac{p-1}{2}}\equiv 1\pmod p$ 有 $\dfrac{p-1}{2}$ 个解。所以模 $p$ 意义下二次剩余和二次非剩余均有 $\dfrac{p-1}{2}$ 个。
</code></pre>
<h2 id="legendre">Legendre 符号</h2>
<p>为了方便接下来的讨论，我们引入如下记号：</p>
<p>???+ abstract "Legendre 符号"
    对 <strong>奇素数</strong>  <span class="arithmatex">\(p\)</span> 和整数 <span class="arithmatex">\(a\)</span>，定义 Legendre 符号如下：</p>
<pre><code>$$
\left(\frac{a}{p}\right)=\begin{cases}
    0,  &amp; p\mid a,\\
    1,  &amp; (p\nmid a) \land ((\exists x\in\mathbf{Z}),~~a\equiv x^2\pmod p),\\
    -1, &amp; \text{otherwise}.\\
\end{cases}
$$
</code></pre>
<p>即对于 <span class="arithmatex">\((a,p)=1\)</span> 的 <span class="arithmatex">\(a\)</span>，</p>
<ul>
<li><span class="arithmatex">\(a\)</span> 是模 <span class="arithmatex">\(p\)</span> 的二次剩余当且仅当 <span class="arithmatex">\(\left(\dfrac{a}{p}\right)=1.\)</span></li>
<li><span class="arithmatex">\(a\)</span> 是模 <span class="arithmatex">\(p\)</span> 的二次非剩余当且仅当 <span class="arithmatex">\(\left(\dfrac{a}{p}\right)=-1.\)</span></li>
</ul>
<p>下表为部分 Legendre 符号的值（From <a href="https://en.wikipedia.org/wiki/Legendre_symbol#Table_of_values">Wikipedia</a>）</p>
<p><img alt="" src="../images/quad_residue.png" /></p>
<h3 id="_3">性质</h3>
<ol>
<li>
<p>对任意整数 <span class="arithmatex">\(a\)</span>，</p>
<div class="arithmatex">\[
a^{\frac{p-1}{2}}\equiv \left(\frac{a}{p}\right)\pmod p.
\]</div>
<p>进一步，我们有推论：</p>
<ul>
<li>
<div class="arithmatex">\[
    \left(\dfrac{1}{p}\right)=1.
    \]</div>
</li>
<li>
<div class="arithmatex">\[
    \left(\dfrac{-1}{p}\right)=(-1)^{\frac{p-1}{2}}=\begin{cases}
        1,  &amp; p\equiv 1\pmod 4,\\
        -1, &amp; p\equiv 3\pmod 4.
        \end{cases}
    \]</div>
</li>
</ul>
</li>
<li>
<p><span class="arithmatex">\(a_1\equiv a_2\pmod p\implies \left(\dfrac{a_1}{p}\right)=\left(\dfrac{a_2}{p}\right).\)</span></p>
</li>
<li>
<p>（<a href="../basic/#积性函数">完全积性</a>）对任意整数 <span class="arithmatex">\(a_1,a_2\)</span>，</p>
<div class="arithmatex">\[
\left(\frac{a_1a_2}{p}\right)=\left(\frac{a_1}{p}\right)\left(\frac{a_2}{p}\right).
\]</div>
<p>我们有推论：对整数 <span class="arithmatex">\(a,b\)</span>，<span class="arithmatex">\(p\nmid b\)</span> 有</p>
<div class="arithmatex">\[
\left(\frac{ab^2}{p}\right)=\left(\frac{a}{p}\right).
\]</div>
</li>
<li>
<div class="arithmatex">\[
    \left(\frac{2}{p}\right)=(-1)^{\frac{p^2-1}{8}}=\begin{cases}
            1,  &amp; p\equiv \pm 1\pmod 8, \\
            -1, &amp; p\equiv \pm 3\pmod 8. \\
        \end{cases}
    \]</div>
</li>
</ol>
<p>??? note "证明"
    1.  由 <a href="#legendre-符号">Legendre 符号的定义</a> 和 <a href="#euler-判别法">Euler 判别法</a> 易得。
    2.  注意到</p>
<pre><code>    $$
    a_1\equiv a_2\pmod p\implies \left(\frac{a_1}{p}\right)\equiv\left(\frac{a_2}{p}\right)\pmod p,
    $$

    而 $\left|\left(\dfrac{a_1}{p}\right)-\left(\dfrac{a_2}{p}\right)\right|\leq 2$ 且 $p&gt;2$，故：

    $$
    a_1\equiv a_2\pmod p\implies \left(\frac{a_1}{p}\right)=\left(\frac{a_2}{p}\right).
    $$
3.  由 1 得

    $$
    \left(\frac{a_1a_2}{p}\right)\equiv a_1^{\frac{p-1}{2}}a_2^{\frac{p-1}{2}}\equiv\left(\frac{a_1}{p}\right)\left(\frac{a_2}{p}\right)\pmod p.
    $$

    而 $\left|\left(\dfrac{a_1a_2}{p}\right)-\left(\dfrac{a_1}{p}\right)\left(\dfrac{a_2}{p}\right)\right|\leq 2$ 且 $p&gt;2$，故

    $$
    \left(\frac{a_1a_2}{p}\right)=\left(\frac{a_1}{p}\right)\left(\frac{a_2}{p}\right).
    $$
4.  参见 [二次互反律](#二次互反律)
</code></pre>
<p>基于如上性质，若对任意奇素数 <span class="arithmatex">\(p\)</span> 和 <span class="arithmatex">\(q\)</span>，<span class="arithmatex">\(\left(\dfrac{p}{q}\right)\)</span> 的值均可计算，则我们就可以对任意合法情况计算 Legendre 符号的值。接下来我们有一个优美的定理，这个定理巧妙地在 <span class="arithmatex">\(\left(\dfrac{p}{q}\right)\)</span> 和 <span class="arithmatex">\(\left(\dfrac{q}{p}\right)\)</span> 之间建立起了联系，使得我们能用类似 <a href="../gcd/#欧几里得算法">辗转相除法</a> 的思路完成计算。</p>
<h3 id="_4">二次互反律</h3>
<p>???+ note "二次互反律"
    设 <span class="arithmatex">\(p\)</span>，<span class="arithmatex">\(q\)</span> 是两个不同的奇素数，则</p>
<pre><code>$$
\left(\frac{p}{q}\right)\left(\frac{q}{p}\right)=(-1)^{\frac{p-1}{2}\frac{q-1}{2}}.
$$
</code></pre>
<p>证明方式很多[^ref5]。一种证明方式是基于如下引理[^ref6]：</p>
<p>???+ note "Gauss 引理"
    设 <span class="arithmatex">\(p\)</span> 是奇素数，<span class="arithmatex">\((n,p)=1\)</span>，对整数 <span class="arithmatex">\(k~\left(1\leq k\leq (p-1)/2\right)\)</span>，令 <span class="arithmatex">\(r_k=nk\bmod p\)</span>，设 <span class="arithmatex">\(A=\{r_k:r_k &lt; p/2\}\)</span>，<span class="arithmatex">\(B=\{r_k:r_k &gt; p/2\}\)</span>，则</p>
<pre><code>$$
\left(\frac{n}{p}\right)=(-1)^{|B|}.
$$
</code></pre>
<p>??? note "证明"
    设 <span class="arithmatex">\(\lambda=|A|\)</span>，<span class="arithmatex">\(\mu=|B|\)</span>，显然 <span class="arithmatex">\(\lambda+\mu=(p-1)/2\)</span>，则</p>
<pre><code>$$
n^{\frac{p-1}{2}}\left(\frac{p-1}{2}\right)!=\prod_{k=1}^{\frac{p-1}{2}} nk\equiv\prod_{a\in A}a\prod_{b\in B}b\pmod{p}.
$$

我们知道对 $B$ 中任意元素 $b$，有 $\dfrac{p}{2} &lt; b &lt; p$，所以 $0 &lt; p-b &lt; \dfrac{p}{2}$，进一步，对 $B$ 中任意元素 $b$，我们有 $p-b\notin A$，否则若 $A,B$ 中分别存在元素 $a,b$ 使得 $a=p-b$，则存在整数 $0 &lt; k_1,k_2 &lt; (p-1)/2$ 使得 $a=nk_1$，$b=nk_2$ 且 $p\mid n(k_1+k_2)$，由于 $(n,p)=1$，则 $p\mid (k_1+k_2)$，注意到 $0 &lt; k_1+k_2 &lt; p$，所以产生矛盾。因此

$$
n^{\frac{p-1}{2}}\left(\frac{p-1}{2}\right)!\equiv(-1)^{\mu}\prod_{a\in A}a\prod_{b\in B}(p-b)=(-1)^{\mu}\left(\frac{p-1}{2}\right)!\pmod{p},
$$

即

$$
n^{\frac{p-1}{2}}\equiv(-1)^{\mu}\pmod{p}.
$$

从而由 Legendre 符号的 [性质 1](#性质) 即得证。
</code></pre>
<p>??? tip "推广"
    Gauss 引理可做如下推广[^ref7]：</p>
<pre><code>设 $p$ 是奇素数，令 $I\subset\mathbf{Z}_p^*$ 满足 $I\cup -I=\mathbf{Z}_p^*$ 且 $I\cap -I=\varnothing$，其中 $-I:=\{-i:i\in I\}$，则对任意与 $p$ 互质的整数 $n$，

$$
\left(\frac{n}{p}\right)=(-1)^{|J|},
$$

其中 $J=\{j\in I:nj\in -I\}$.

不难发现取 $I=\{1,2,\dots,(p-1)/2\}$ 即可得到 Gauss 引理。证明方法和 Gauss 引理的证明基本相同，故省略。
</code></pre>
<p>容易得到如下推论：</p>
<p>???+ note "推论"
    对奇素数 <span class="arithmatex">\(p\)</span>，有</p>
<pre><code>$$
\left(\frac{2}{p}\right)=(-1)^{\frac{p^2-1}{8}}=\begin{cases}
        1,  &amp; p\equiv \pm 1\pmod 8, \\
        -1, &amp; p\equiv \pm 3\pmod 8. \\
    \end{cases}
$$

对奇素数 $p$，奇数 $n$ 满足 $(n,p)=1$，有

$$
\left(\frac{n}{p}\right)=(-1)^{\sum_{i=1}^{(p-1)/2}\lfloor ni/p \rfloor}.
$$
</code></pre>
<p>??? note "证明"
    对 Gauss 引理中的 <span class="arithmatex">\(n,k,r_k,A,B,\lambda,\mu\)</span>，有 <span class="arithmatex">\(nk=p\left\lfloor\dfrac{nk}{p}\right\rfloor+r_k\)</span>，进而</p>
<pre><code>$$
\begin{aligned}
    n\cdot\frac{p^2-1}{8}=\sum_{k=1}^{\frac{p-1}{2}}nk&amp;=p\sum_{k=1}^{\frac{p-1}{2}}\left\lfloor\dfrac{nk}{p}\right\rfloor+\sum_{a\in A}a+\sum_{b\in B}b\\
    &amp;=p\sum_{k=1}^{\frac{p-1}{2}}\left\lfloor\dfrac{nk}{p}\right\rfloor+\sum_{a\in A}a+\sum_{b\in B}(p-b)+2\sum_{b\in B}b-p\mu\\
    &amp;=p\sum_{k=1}^{\frac{p-1}{2}}\left\lfloor\dfrac{nk}{p}\right\rfloor+\sum_{k=1}^{\frac{p-1}{2}}k+2\sum_{b\in B}b-p\mu\\
    &amp;=p\sum_{k=1}^{\frac{p-1}{2}}\left\lfloor\dfrac{nk}{p}\right\rfloor+\frac{p^2-1}{8}+2\sum_{b\in B}b-p\mu,
\end{aligned}
$$

因此

$$
(n-1)\frac{p^2-1}{8}=p\sum_{k=1}^{\frac{p-1}{2}}\left\lfloor\dfrac{nk}{p}\right\rfloor+2\sum_{b\in B}b-p\mu.
$$

若 $n=2$，则 $0 &lt; \dfrac{nk}{p}\leq\dfrac{p-1}{p} &lt; 1$，从而有

$$
\frac{p^2-1}{8}\equiv\mu\pmod{2}.
$$

若 $2\nmid n$，则有

$$
\sum_{k=1}^{\frac{p-1}{2}}\left\lfloor\dfrac{nk}{p}\right\rfloor\equiv\mu\pmod{2}.
$$
</code></pre>
<p>根据如上推论，证明二次互反律只需验证</p>
<div class="arithmatex">\[
\frac{p-1}{2}\frac{q-1}{2}=\sum_{k=1}^{\frac{p-1}{2}}\left\lfloor\dfrac{qk}{p}\right\rfloor+\sum_{k=1}^{\frac{q-1}{2}}\left\lfloor\dfrac{pk}{q}\right\rfloor.
\]</div>
<p>考虑由点 <span class="arithmatex">\((px,qy)\)</span>，<span class="arithmatex">\(1\leq x\leq \dfrac{q-1}{2},1\leq y\leq \dfrac{p-1}{2}\)</span> 构成的集合 <span class="arithmatex">\(S\)</span>，将其根据 <span class="arithmatex">\(px\)</span> 与 <span class="arithmatex">\(qy\)</span> 的大小关系分成两部分（显然 <span class="arithmatex">\(px\neq qy\)</span>），分别验证三个集合的大小即可。</p>
<p>二次互反律不仅能用于判断数 <span class="arithmatex">\(n\)</span> 是否是模 <span class="arithmatex">\(p\)</span> 的二次剩余，还能用于确定使数 <span class="arithmatex">\(n\)</span> 为二次剩余的模数的结构。</p>
<p>???+ example "Example"
    -   使得 <span class="arithmatex">\(5\)</span> 为二次剩余的奇素数 <span class="arithmatex">\(p\)</span> 满足 <span class="arithmatex">\(p\equiv \pm 1\pmod 5.\)</span>
    -   使得 <span class="arithmatex">\(-3\)</span> 为二次剩余的奇素数 <span class="arithmatex">\(p\)</span> 满足 <span class="arithmatex">\(p\equiv 1\pmod 3.\)</span>
    -   使得 <span class="arithmatex">\(-2\)</span>，<span class="arithmatex">\(3\)</span> 同时为二次剩余的奇素数 <span class="arithmatex">\(p\)</span> 满足 <span class="arithmatex">\(p\equiv 11\pmod{24}.\)</span></p>
<p>另外，我们还可以证明诸如「形如 <span class="arithmatex">\(4k+1\)</span> 的素数有无限多个」之类的结论，这一类结论实际上是 <a href="https://en.wikipedia.org/wiki/Dirichlet%27s_theorem_on_arithmetic_progressions">Dirichlet 定理</a> 的简单推论。</p>
<h2 id="jacobi">Jacobi 符号</h2>
<p>根据二次互反律，我们可以很自然地想到一种推广 Legendre 符号的方法：</p>
<p>???+ abstract "Jacobi 符号"
    对 <strong>正奇数</strong>  <span class="arithmatex">\(m=p_1^{\alpha_1}\dots p_k^{\alpha_k}\)</span> 和整数 <span class="arithmatex">\(a\)</span>，其中 <span class="arithmatex">\(p_1,\dots,p_k\)</span> 是素数，<span class="arithmatex">\(\alpha_1,\dots,\alpha_k\)</span> 是正整数，定义 Jacobi 符号如下：</p>
<pre><code>$$
\left(\frac{a}{m}\right):=\prod_{i=1}^k\left(\frac{a}{p_i}\right)^{\alpha_i}.
$$

其中等式右端的 $\left(\frac{a}{p_i}\right)$ 为 [Legendre 符号](#legendre-符号)。另外对整数 $a$ 有 $\left(\dfrac{a}{1}\right)=1.$
</code></pre>
<p>???+ warning "Warning"
    我们一般不区分 Legendre 符号和 Jacobi 符号，因为由完全积性可知 Jacobi 符号具有和 Legendre 符号一样的性质，所以这两种符号的计算方法是一致的。但是有一点需要注意：当 <span class="arithmatex">\(m\)</span>  <strong>不是奇素数</strong> 时，<span class="arithmatex">\(\left(\dfrac{a}{m}\right)\)</span> 的值与 <span class="arithmatex">\(a\)</span> 是否是模 <span class="arithmatex">\(m\)</span> 的二次剩余 <strong>无关</strong>，但是若 <span class="arithmatex">\(\left(\dfrac{a}{m}\right)=-1\)</span>，则说明 <span class="arithmatex">\(m\)</span> 至少存在一个（实际上是奇数个）素因子 <span class="arithmatex">\(p\)</span> 使得 <span class="arithmatex">\(a\)</span> 是模 <span class="arithmatex">\(p\)</span> 的二次非剩余，从而此时 <span class="arithmatex">\(a\)</span> 是模 <span class="arithmatex">\(m\)</span> 的二次非剩余。</p>
<p>我们还可以把模数进一步推广为 <strong>整数</strong>（只需补充 <span class="arithmatex">\(\left(\dfrac{a}{-1}\right)\)</span>、<span class="arithmatex">\(\left(\dfrac{a}{0}\right)\)</span> 和 <span class="arithmatex">\(\left(\dfrac{a}{2}\right)\)</span> 的定义），这样就得到了 <a href="https://en.wikipedia.org/wiki/Kronecker_symbol">Kronecker 符号</a>。</p>
<h2 id="_5">模意义下开平方</h2>
<p>本节讨论模意义下开平方的算法。特别地，本节主要介绍素数模的情形。对于一般模数的情形，可以参考 <a href="../residue/#模意义下开方">模意义下开高次方</a> 的讨论。</p>
<h3 id="_6">特殊情况时的算法</h3>
<p>对于同余方程 <span class="arithmatex">\(x^2\equiv a\pmod p\)</span>，其中 <span class="arithmatex">\(p\)</span> 为奇素数且 <span class="arithmatex">\(a\)</span> 为二次剩余在 <span class="arithmatex">\(p\bmod 4=3\)</span> 时有更简单的解法，考虑</p>
<div class="arithmatex">\[
\begin{aligned}
\left(a^{(p+1)/4}\right)^2&amp;\equiv a^{(p+1)/2}&amp;\pmod p\\
&amp;\equiv x^{p+1}&amp;\pmod p\\
&amp;\equiv \left(x^2\right)\left(x^{p-1}\right)&amp;\pmod p\\
&amp;\equiv x^2&amp;\pmod p&amp;\quad (\because{\text{Fermat's little theorem}})
\end{aligned}
\]</div>
<p>那么 <span class="arithmatex">\(a^{(p+1)/4}\bmod p\)</span> 为一个解。</p>
<h4 id="atkin">Atkin 算法</h4>
<p>仍然考虑上述同余方程，此时 <span class="arithmatex">\(p\bmod 8=5\)</span>，那么令 <span class="arithmatex">\(b\equiv (2a)^{(p-5)/8}\pmod p\)</span> 和 <span class="arithmatex">\(\mathrm{i}\equiv 2ab^2\pmod p\)</span> 那么此时 <span class="arithmatex">\(\mathrm{i}^2\equiv -1\pmod p\)</span> 且 <span class="arithmatex">\(ab(\mathrm{i}-1)\bmod p\)</span> 为一个解。</p>
<p>???+ note "证明"
    $$
    \begin{aligned}
    \mathrm{i}^2&amp;\equiv\left(2ab^2\right)^2&amp;\pmod p\
    &amp;\equiv \left(2a\cdot \left(2a\right)^{(p-5)/4}\right)^2&amp;\pmod p\
    &amp;\equiv \left(\left(2a\right)^{(p-1)/4}\right)^2&amp;\pmod p\
    &amp;\equiv \left(2a\right)^{\frac{p-1}{2}}&amp;\pmod p\
    &amp;\equiv -1&amp;\pmod p
    \end{aligned}
    $$</p>
<pre><code>那么

$$
\begin{aligned}
\left(ab(\mathrm{i}-1)\right)^2&amp;\equiv a^2\cdot \left(2a\right)^{(p-5)/4}\cdot (-2\mathrm{i})&amp;\pmod p\\
&amp;\equiv a\cdot (-\mathrm{i})\cdot \left(2a\right)^{(p-1)/4}&amp;\pmod p\\
&amp;\equiv a&amp;\pmod p
\end{aligned}
$$
</code></pre>
<h3 id="cipolla">Cipolla 算法</h3>
<p>Cipolla 算法用于求解同余方程 <span class="arithmatex">\(y^2\equiv a\pmod p\)</span>，其中 <span class="arithmatex">\(p\)</span> 为奇素数且 <span class="arithmatex">\(a\)</span> 为二次剩余。</p>
<p>本节考虑 <span class="arithmatex">\(\mathbf{F}_p\lbrack x\rbrack /(x^2-g)\)</span> 中的运算，其中 <span class="arithmatex">\(g \in \mathbf{F}_p\)</span>。</p>
<p>??? note "计算方法"
    不熟悉 <a href="../../algebra/ring-theory/#多项式环">多项式环</a> 的读者，可以简单理解为该集合的元素都具有形式 <span class="arithmatex">\(a_0+a_1x\)</span> 且 <span class="arithmatex">\(a_0,a_1\in\mathbf F_p\)</span>，且遵循如下运算法则：</p>
<pre><code>$$
\begin{aligned}
(a_0+a_1x)+(b_0+b_1x) &amp;\equiv (a_0+b_0)+(a_1+b_1)x &amp;\pmod{(x^2-g)}\\
(a_0+a_1x)(b_0+b_1x) &amp;\equiv (a_0b_0+a_1b_1g)+(a_1b_0+a_0b_1)x &amp;\pmod{(x^2-g)}
\end{aligned}
$$

需要注意的是，此处的 $x$ 并不是一个具体的数，而是表示多项式中的形式记号。运算中一个关键的点在于利用 $x^2 \equiv g \pmod{(x^2-g)}$ 将二次项转化为一次项和常数项。另外，所有整数运算都需要对 $p$ 取模。

关于该结构的更多内容，请参见 [多项式](../poly/intro.md) 和 [域论](../algebra/field-theory.md) 等页面。
</code></pre>
<p>该算法的第一步为找到一个 <span class="arithmatex">\(r\)</span> 使得 <span class="arithmatex">\(r^2-a\)</span> 为二次非剩余。当然对于 <span class="arithmatex">\(a \equiv 0 \pmod p\)</span> 不可能找到这样的 <span class="arithmatex">\(r\)</span>，需要进行特判。下文只讨论 <span class="arithmatex">\(a \not\equiv 0 \pmod p\)</span> 的情况。此时可随机一个 <span class="arithmatex">\(r\)</span> 然后判断，期望可以 <span class="arithmatex">\(2\)</span> 步找到。于是，<span class="arithmatex">\((r-x)^{\frac{p+1}{2}}\bmod (x^2-(r^2-a))\)</span> 为一个解，可以通过快速幂求值。</p>
<p>??? note "为什么期望只需要两步"
    考虑 <span class="arithmatex">\(r^2-a\)</span> 为二次剩余的情况，则存在一个 <span class="arithmatex">\(x\)</span> 使得 <span class="arithmatex">\(r^2-a \equiv x^2 \pmod p\)</span>，移项可得 <span class="arithmatex">\((r+x)(r-x) \equiv a \pmod p\)</span>，不难发现每一个 <span class="arithmatex">\((r+x) \in [1, p-1]\)</span>，都一一对应于一组 <span class="arithmatex">\((r,x)\)</span> 的解，所以使原方程成立的解一共有 <span class="arithmatex">\(p-1\)</span> 组。我们分类讨论 <span class="arithmatex">\(x \equiv 0\)</span> 和 <span class="arithmatex">\(x \not\equiv 0\)</span> 两种情况。对于 <span class="arithmatex">\(x \equiv 0\)</span>，由于 <span class="arithmatex">\(a\)</span> 是二次剩余，对应了 <span class="arithmatex">\(2\)</span> 种 <span class="arithmatex">\(r\)</span> 的取值；对于 <span class="arithmatex">\(x \not\equiv 0\)</span>，有 <span class="arithmatex">\(p-1-2\)</span> 种情况，每一个 <span class="arithmatex">\(r\)</span> 对应其中两种，一共有 <span class="arithmatex">\(\dfrac{p-3}{2}\)</span> 种 <span class="arithmatex">\(r\)</span> 的取值。综上，一共有 <span class="arithmatex">\(2+\dfrac{p-3}{2}=\dfrac{p+1}{2}\)</span> 种情况使得 <span class="arithmatex">\(r^2-a\)</span> 为二次剩余，所以每随机一次得到二次非剩余的概率就是 <span class="arithmatex">\(\dfrac{p-1}{2p}\)</span>，期望步数为 <span class="arithmatex">\(\dfrac{2p}{p-1} \approx 2\)</span>。</p>
<p>???+ note "证明"
    为了方便，首先令 <span class="arithmatex">\(f(x)=x^2-(r^2-a)\in\mathbf{F}_p\lbrack x\rbrack\)</span>。</p>
<pre><code>需要证明的是，$(r-x)^{\frac{p+1}{2}} \bmod f(x)$ 是原式的解，并且它属于 $\mathbf{F}_p$。首先考虑证明前者，即证明 $(r-x)^{p+1}\equiv a\pmod {f(x)}$。为此，我们需要先证明两个引理：

**引理 1：** $x^p \equiv -x \pmod {f(x)}$

证明：

$$
\begin{aligned}
x^p&amp;= x(x^2)^{\frac{p-1}{2}}\\
&amp;\equiv x(r^2-a)^{\frac{p-1}{2}}&amp;\pmod{f(x)}&amp;\quad (\because{x^2\equiv r^2-a\pmod{f(x)}})\\
&amp;\equiv -x&amp;\pmod{f(x)}&amp;\quad (\because{r^2-a}\text{ is quadratic non-residue})
\end{aligned}
$$

**引理 2：**$(a+b)^p \equiv a^p+b^p \pmod p$

使用二项式定理容易发现，除了第一项和最后一项，分子上的 $p$ 无法消掉，于是只剩下 $a^p+b^p$。

$$
\begin{aligned}
(a+b)^p&amp;=\sum_{i=0}^p\binom{p}{i}a^ib^{p-i}\\
&amp;=\sum_{i=0}^p\frac{p!}{i!(p-i)!}a^ib^{p-i}\\
&amp;\equiv a^p+b^p\pmod p
\end{aligned}
$$

有了这两个引理，我们再来考虑证明原式：

$$
\begin{aligned}
(r-x)^{p+1}
&amp;= (r-x)^p(r-x)\\
&amp;\equiv (r^p-x^p)(r-x)&amp;\pmod{f(x)}\\
&amp;\equiv (r+x)(r-x)&amp;\pmod{f(x)}\\
&amp;= r^2-x^2\\
&amp;\equiv r^2-(r^2-a)&amp;\pmod{f(x)}\\
&amp;= a\\
\end{aligned}
$$

下面通过反证法证明我们求出的解属于 $\mathbf{F}_p$，即其 $x$ 的系数为 $0$。

假设存在一个 $(a_0+a_1x)^2 \equiv a \pmod {f(x)}$ 满足 $a_1 \not\equiv 0 \pmod p$，即 $a_0^2+2a_0a_1x+a_1^2x^2 \equiv a \pmod {f(x)}$，移项并化简可得：

$$
a_0^2+a_1^2(r^2-a)-a \equiv -2a_0a_1x \pmod {f(x)}
$$

式子左边的 $x$ 的系数为 $0$，所以右边 $x$ 的系数也为 $0$，即 $a_0a_1 \equiv 0 \pmod p$，由于我们令 $a_1 \not\equiv 0 \pmod p$，所以一定有 $a_0 \equiv 0 \pmod p$，于是 $(a_1x)^2 \equiv a \pmod {f(x)}$ 即 $r^2-a \equiv aa_1^{-2} \pmod p$。

由于 $a$ 和 $a_1^{-2}$ 都是二次剩余，由 Legendre 符号的积性可知 $aa_1^{-2}$ 也是二次剩余，这与 $r^2-a$ 是二次非剩余矛盾。于是原式不存在一个解使得 $x$ 的系数非 $0$，我们求出的解的 $x$ 的系数也必定为 $0$。
</code></pre>
<p>??? example "模板题 <a href="https://www.luogu.com.cn/problem/P5491">洛谷 P5491【模板】二次剩余</a>"
    <code>cpp
    --8&lt;-- "docs/math/code/quad-residue/quad-residue_1.cpp"</code></p>
<h3 id="bostanmori">Bostan–Mori 算法</h3>
<p>该算法基于 Cipolla 算法，我们将问题转换为 <a href="../../poly/linear-recurrence/">常系数齐次线性递推</a> 再应用 Bostan–Mori 算法。考虑另一种常见的 Cipolla 算法的描述：<span class="arithmatex">\(b=x^{\left(p+1\right)/2}\bmod{\left(x^2-tx+a\right)}\)</span> 为满足 <span class="arithmatex">\(b^2\equiv a\pmod{p}\)</span> 的一个解[^ref3]，其中 <span class="arithmatex">\(x^2-tx+a\in \mathbf{F}_p\lbrack x\rbrack\)</span> 为不可约多项式。系数 <span class="arithmatex">\(t\)</span> 的选取同样使用随机方法。证明过程略。参考 Bostan 和 Mori 论文[^ref4]中的算法我们可以发现问题可转化为求解形式幂级数的乘法逆元的某一项系数：</p>
<div class="arithmatex">\[
b=\left\lbrack x^{(p+1)/2}\right\rbrack\dfrac{1}{1-tx+ax^2}
\]</div>
<p>且</p>
<div class="arithmatex">\[
\left\lbrack x^n\right\rbrack\dfrac{k_0+k_1x}{1+k_2x+k_3x^2}=
\begin{cases}
\left\lbrack x^{(n-1)/2}\right\rbrack\dfrac{k_1-k_0k_2+k_1k_3x}{1+(2k_3-k_2^2)x+k_3^2x^2},&amp;\text{if }n\bmod 2=1\\
\left\lbrack x^{n/2}\right\rbrack\dfrac{k_0+(k_0k_3-k_1k_2)x}{1+(2k_3-k_2^2)x+k_3^2x^2},&amp;\text{else if }n\neq 0
\end{cases}
\]</div>
<p>而 <span class="arithmatex">\(n=0\)</span> 时显然有 <span class="arithmatex">\(\left\lbrack x^0\right\rbrack\dfrac{k_0+k_1x}{1+k_2x+k_3x^2}=k_0\)</span>，该算法乘法次数相较于 Cipolla 算法更少。其他相关乘法次数较少的算法可见 Müller 的文章[^ref2]。</p>
<h3 id="legendre_1">Legendre 算法</h3>
<p>对于同余方程 <span class="arithmatex">\(x^2\equiv a\pmod p\)</span>，其中 <span class="arithmatex">\(p\)</span> 为奇素数且 <span class="arithmatex">\(a\)</span> 为二次剩余。Legendre 算法可描述为找到 <span class="arithmatex">\(r\)</span> 满足 <span class="arithmatex">\(r^2-a\)</span> 为二次非剩余，令 <span class="arithmatex">\(a_0+a_1x=(r-x)^{\frac{p-1}{2}}\bmod (x^2-a)\)</span>，那么 <span class="arithmatex">\(a_0\equiv 0\pmod p\)</span> 且 <span class="arithmatex">\(a_1^{-2}\equiv a\pmod p\)</span>.</p>
<p>???+ note "证明"
    考虑选择一个 <span class="arithmatex">\(b\)</span> 满足 <span class="arithmatex">\(b^2\equiv a\pmod p\)</span>，那么 <span class="arithmatex">\((r-b)(r+b)=r^2-a\)</span> 为二次非剩余，所以</p>
<pre><code>$$
(r-b)^{\frac{p-1}{2}}(r+b)^{\frac{p-1}{2}}\equiv -1\pmod p
$$

存在环态射

$$
\begin{aligned}
\phi:\mathbf{F}_p\lbrack x\rbrack/(x^2-a)&amp;\to \mathbf{F}_p\times \mathbf{F}_p\\
x&amp;\mapsto (b,-b)
\end{aligned}
$$

那么

$$
\begin{aligned}
(a_0+a_1b,a_0-a_1b)&amp;=\phi(a_0+a_1x)\\
&amp;=\phi(r-x)^{\frac{p-1}{2}}\\
&amp;=((r-b)^{\frac{p-1}{2}},(r+b)^{\frac{p-1}{2}})\\
&amp;=(\pm 1,\mp 1)
\end{aligned}
$$

所以 $2a_0=(\pm 1)+(\mp 1)=0$ 而 $2a_1b=(\pm 1)-(\mp 1)=\pm 2$.
</code></pre>
<h3 id="tonellishanks">Tonelli–Shanks 算法</h3>
<p>Tonelli–Shanks 算法是基于离散对数求解同余方程 <span class="arithmatex">\(x^2\equiv a\pmod p\)</span> 的算法[^ref1]，其中 <span class="arithmatex">\(p\)</span> 为奇素数且 <span class="arithmatex">\(a\)</span> 为模 <span class="arithmatex">\(p\)</span> 的二次剩余。</p>
<p>令 <span class="arithmatex">\(p-1=m2^n\)</span>，其中 <span class="arithmatex">\(m\)</span> 为奇数。仍然使用随机方法寻找 <span class="arithmatex">\(r\in\mathbf{F}_p\)</span> 满足 <span class="arithmatex">\(r\)</span> 为二次非剩余。令 <span class="arithmatex">\(g\equiv r^m\pmod p\)</span> 且 <span class="arithmatex">\(b\equiv a^{(m-1)/2}\pmod p\)</span>，那么存在整数 <span class="arithmatex">\(e\in\lbrace 0,1,2,\dots ,2^n-1\rbrace\)</span> 满足 <span class="arithmatex">\(ab^2\equiv g^e\pmod p\)</span>。若 <span class="arithmatex">\(a\)</span> 为二次剩余，那么 <span class="arithmatex">\(e\)</span> 为偶数且 <span class="arithmatex">\(\left(abg^{-e/2}\right)^2\equiv a\pmod p\)</span>.</p>
<p>???+ note "证明"
    根据费马小定理可知</p>
<pre><code>$$
g^{2^n} \equiv r^{m2^n} = r^{p-1} \equiv 1 \pmod p.
$$

又由于 $r$ 是二次非剩余，有

$$
g^{2^{n-1}} \equiv r^{m2^{n-1}} = r^{\frac{p-1}{2}} \equiv -1 \pmod p.  
$$

所以，$g$ 模 $p$ 的阶是 $2^n$。又因为 $ab^2\equiv a^m\pmod p$ 是 $x^{2^n}\equiv 1\pmod p$ 的解，所以 $a^m$ 是 $g$ 的幂次。记 $a^m\equiv g^e\pmod p$。

因为 $a$ 是二次剩余，所以

$$
g^{e2^{n-1}} \equiv a^{m2^{n-1}} = a^{\frac{p-1}{2}} \equiv 1 \pmod p.
$$

由阶的性质可知，$2^n\mid e2^{n-1}$，所以，$e$ 是偶数。因此，$abg^{-e/2}\bmod p$ 是良定义的，且

$$
\left(abg^{-e/2}\right)^2 = a^2b^2g^{-e} \equiv a^{m+1}g^{-e} \equiv a \pmod p.
$$
</code></pre>
<p>剩下的问题是如何计算 <span class="arithmatex">\(e\)</span>。Tonelli 和 Shanks 提出一次确定 <span class="arithmatex">\(e\)</span> 的一个二进制位。令 <span class="arithmatex">\(e\)</span> 在二进制下表示为 <span class="arithmatex">\(e=e_0+2e_1+4e_2+\cdots\)</span>，其中 <span class="arithmatex">\(e_k\in\lbrace 0,1\rbrace\)</span>。因为 <span class="arithmatex">\(a\)</span> 是二次剩余，所以开始时 <span class="arithmatex">\(e_0=0\)</span>，然后利用如下性质逐位确定 <span class="arithmatex">\(e_k\)</span> 的取值：</p>
<div class="arithmatex">\[
\left(g^eg^{-(e\bmod 2^k)}\right)^{2^{n-1-k}}\equiv g^{2^{n-1}\cdot e_k}\equiv 
\begin{cases}
1\pmod p,&amp;\text{if }e_k=0\\
-1\pmod p,&amp;\text{if }e_k=1
\end{cases}
\]</div>
<p>其中，<span class="arithmatex">\(g^e\equiv ab^2\pmod p\)</span> 已知，而 <span class="arithmatex">\(e\bmod 2^k\)</span> 的取值可以由之前的数位 <span class="arithmatex">\(e_0,e_1,\cdots,e_{k-1}\)</span> 计算得到。当然，实现算法时，只需要直接维护乘积 <span class="arithmatex">\(g^eg^{-(e\bmod 2^k)}\bmod p\)</span> 即可。</p>
<h2 id="_7">习题</h2>
<ul>
<li><a href="https://www.luogu.com.cn/problem/P5491">洛谷 P5491【模板】二次剩余</a></li>
<li><a href="https://acm.timus.ru/problem.aspx?space=1&amp;num=1132">「Timus 1132」Square Root</a></li>
</ul>
<h2 id="_8">参考资料与注释</h2>
<ol>
<li><a href="https://en.wikipedia.org/wiki/Quadratic_residue">Quadratic residue - Wikipedia</a></li>
<li><a href="https://en.wikipedia.org/wiki/Euler%27s_criterion">Euler's criterion - Wikipedia</a></li>
</ol>
<p>[^ref1]: Daniel. J. Bernstein. Faster Square Roots in Annoying Finite Fields.</p>
<p>[^ref2]: S. Müller, On the computation of square roots in finite fields, Design, Codes and Cryptography, Vol.31, pp. 301-312, 2004.</p>
<p>[^ref3]: A. Menezes, P. van Oorschot and S. Vanstone. Handbook of Applied Cryptography, 1996.</p>
<p>[^ref4]: Alin Bostan, Ryuhei Mori. A Simple and Fast Algorithm for Computing the N-th Term of a Linearly Recurrent Sequence. Available at <a href="https://arxiv.org/abs/2008.08822">https://arxiv.org/abs/2008.08822</a>.</p>
<p>[^ref5]: <a href="https://en.wikipedia.org/wiki/Proofs_of_quadratic_reciprocity">Proofs of quadratic reciprocity - Wikipedia</a></p>
<p>[^ref6]: Carl Friedrich Gauss. Untersuchungen über höhere Arithmetik, 1965. Page 458-462.</p>
<p>[^ref7]: Kobi Kremnizer.<a href="https://courses.maths.ox.ac.uk/pluginfile.php/29788/mod_resource/content/1/numbertheory-2022.pdf">Lectures in number theory 2022</a>. Proposition 4.3.</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.expand", "navigation.tabs"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>